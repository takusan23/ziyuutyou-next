---
title: curl で 200 返ってくるのに、Node.js でリクエストすると 403 が返ってくる件の調査
created_at: 2023-08-13
tags:
- Linux
---

タイトル通りで、`curl`だと`200`で成功するリクエストが、適当な言語（今回は`Node.js`）の`HTTP クライアント`を使ってリクエストしようとすると、なぜか`403`でエラーになる件の調査をしました。

# 結果は...
`Node.js`のバージョンが古かった...  
`Node.js 16`だとリクエストに失敗しますが、`18`にしたら治りました。なぜ...

# この件の経緯

- お一人様`Misskey`を建てた
- お一人様`Misskey`から一部のサーバーのユーザーを検索できない事がわかった
    - ログを見ると`403`エラーになっている
    - `VPS`の`curl`でも失敗している
- 手元の`Windows`マシンではリクエストが成功する
    - 手元でも失敗か～と思いきや`ユーザーエージェント`付けたら動いた
        - `curl -H 'User-Agent: @takusan_23' https://example.com`
- `VPS`の`IPアドレス`がブラックリスト入りしてると考える
- 大体`Misskey`サーバーは`Cloudflare`でプロキシしているはず...
    - `Cloudflare`を疑う
- しかし`misskey.io`など、`Cloudflare`を使っている（であろう）サーバーのユーザーをフォローできている
    - 今度は繋がらないサーバーを疑う
        - 意図的に弾いているとかは考えにくいが
- と思ったが、他にもお一人様サーバーから繋がらないサーバーが出てくる
    - 知ってる限り二件ぐらいある
    - 流石に複数のサーバーからIPアドレスを狙い撃ちでブロックされているとは考えにくい
        - じゃあ`Cloudflare`か？
            - でも繋がるサーバーあるんだよな
- `グローバルIPアドレス`を変更してみる
    - `AWS Lightsail`なら`静的IP`のデタッチしてアタッチすると新しいのが降ってくる
        - しかしダメ
        - ここで`AWS`が狙い撃ちされているのではと考える

--- 挫折 ---

- ふと、`AWS CloudShell`というサービスがあることに気付く
    - すぐに使える`Linux`マシンみたいなやつ
        - `Linux`しか用意されてないアプリとかを入れておくと良さそう
            - `Windows`だと使えないから～`EC2 / Lightsail`建てて使いたい`Linux`アプリを入れる！みたいなことが回避できる
    - `curl`とか検証用のツールを入れておくと良いのかな
- `AWS CloudShell`で`curl`してみる
    - リクエストが通る！！！
    - やっぱ`AWS Lightsail`が狙い撃ちされているのではと考える

他に案がないため一旦あきらめる

- `Cloudflare` が `.dev` のトップレベルドメインをサポートする
- 私のお一人様も`Cloudflare`でプロキシ（`Cloudflare DNS`を使う）すれば`IPアドレス`がブラックリスト入りされてるのも治るのではと予測
    - 失敗
    - まぁそれはそう。関係ないよな

挫折。ぐぬぬ

- ふと、`EC2`で建てたらどうなるのか試したくなる
    - 他にも`AWS`で動かしているサーバーがあってもおかしくないはず
- ちょうど無料枠がある
    - `VPC`とか`サブネットマスク`とか`CIDR`とか意味わかんないから避けてた
        - が、`デフォルト VPC`があるのでそれに`EC2`を追加すれば良いことが判明
        - デフォルトを使うのはあんまり良くないらしい
            - `セキュリティグループ`で必要最低限のポートだけ開けるようにする など
- `Ubuntu 20.04`で借りてみる
    - `Amazon Linux`は`CentOS`系列？らしくパッケージマネージャーが`apt`じゃないらしい。ので選ばなかった
- 結果としては失敗だった。
    - 同じエラーが帰ってきた
        - やっぱり`AWS`が狙い撃ちされているのではとまた考える
- ここで、別の`Linux ディストリビューション`を選ぶとどうなるか見てみる
    - `Linux ディストリビューション`が`Ubuntu`だとアクセスできない`IPアドレス`が払い出されるのではと考えた
    - というわけで`Amazon Linux`にしてみました。最新版で
- `Amazon Linux 最新版`だと`curl`のリクエストが通ることが判明
    - ！！！
    - ？？？？？？
    - 流石に`OS`の違いでリクエストの成功に影響するのか...？と考える
- `Ubuntu 22.04 （記述時時点最新版）`で試す
    - `curl`のリクエストが通る
    - この環境に`Node.js 16`を入れて、リクエストするコードを試してみる
        - 通らない...！！
- **ここで curl だと 200 なのに HTTPクライアント だと 403 になる話が始まる**
    - つまり、リクエストの成功に`IP アドレス`は関係ない。事が判明
        - `AWS`だからダメではない
- `curl`リクエストと同じように`HTTP クライアント`のリクエストヘッダーを書いた
    - `curl`に`-v`をつけるとリクエストの詳細が見えます
        - `IP アドレス`がブロックされていないことがわかったため、今度はリクエストヘッダーが悪いのではと
            - リクエストヘッダーを`curl`が付けているものと同じにしてみる
- が、、だめ
    - 今度は`Node.js`の`HTTPクライアント`ライブラリが悪いのではと疑い始める
        - `axios`、`node-fetch`、`got`、`Node.js に最初からあるやつ`を試すも`403`になる
            - `request`ってもう非推奨だったんですね... ；；
        - `curl`では通ってるのに...！

--- 挫折 ---  
いや、流石にこんな事あるか？でも`Mastodon / Misskey`の`Issue`も見たけどないんだよな。（`webfinger`とかいうユーザーを探すプロトコルがあるらしい）  
`Cloudflare`がどうやら弾いてるらしい？ので`Mastodon / Misskey`は関係ないやろと思ったけどなんか1件くらいヒットしてもおかしくないと思うんだけどな...

- ふと、`Node.js`のバージョンを疑い始める
    - きっかけは`Misskey`バージョンアップの記事（忘れた...）
    - `Ubuntu 20 -> 22`にしたら`curl`のリクエストが通るようになったのはネットワークスタック周りで更新があったのではと考える
    - `Node.js`も更新すれば内部のネットワークスタックが更新され通るようになるのではという予測
        - というかこれしかない
            - 似たような`Issue`がないの、私のお一人様は`Ubuntu 20 / Node.js 16`で古いバージョンを使ってる説がある
- **Node.js を 18 にしたら通るようになった！**
    - ![Imgur](https://imgur.com/tuetWqI.png)
    - `IP アドレス`が狙い撃ちされてるとか`AWS`だからダメとか`Cloudflare`に嫌われているとかではなく、**単に私のサーバーのバージョンが古いから**（`Ubuntu 20 / Node.js 16`）一部のサーバーのリクエストが`403`になるみたいでした。
        - ごめんなさい

# おわりに
なおってよかった