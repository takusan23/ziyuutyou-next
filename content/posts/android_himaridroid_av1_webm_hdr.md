---
title: 10 ビット HDR 動画を AV1 エンコードして WebM へ保存する機能を追加しました
created_at: 2025-11-14
tags:
- Android
- WebM
- AV1
---
どうもこんばんわ  
なんか今の`Android Studio（Otter 2025.2.1）`、**めちゃめちゃ CPU 使うんだけど。**

![cpu](https://oekakityou.negitoro.dev/resize/411c4907-1b51-4def-a69d-081c174f44eb.png)

ちなみに文字打ってるだけでこれです。`JetpackCompose`の`@Preview`があるわけでもない。明らかになんかおかしくないですか？  
`Intel Core i5 第8世代`まだ頑張れ！

# 本題
自作アプリの話。  
`10 ビット HDR 動画`を再エンコードする際に`AV1`が選べるようになりました。オープン技術が好きな人！！

![AV1_HDR_AVAILABLE](https://oekakityou.negitoro.dev/resize/098446df-b0f1-4d0d-9802-e508dc47184c.png)

以下の構成が選べるようになります！2つあります！  
`AV1 + Opus + WebM`はどれもオープンでロイヤリティフリー！の特徴がありますのでオススメです。なんか`AV1`は`MP4`よりも`WebM`に入っていてほしいですよね（`VP9`並感）、いや私だけかもですが、、  
`AAC`と`MP4`の権利とかはわからないです。一説によると`Firefox`が`AAC`ダメらしい？

| 映像コーデック | 音声コーデック | コンテナ |
|----------------|----------------|----------|
| AV1            | AAC            | MP4      |
| AV1            | Opus           | WebM     |

まあ`AV1`のハードウェアエンコーダーが`Google Pixel 8 以降`にしか搭載されてなく、それ以外は`CPU`によるソフトウェアエンコーダーを使うので時間がかかるんですけど、、、

# アプリ

今のところこれしか対応してません、

https://play.google.com/store/apps/details?id=io.github.takusan23.himaridroid

動画編集アプリでもやりたいところです。  
↑のアプリでは自前で`WebM`に書き込む処理が別モジュールとして実装されているので、これをライブラリに切り出して呼び出せば良いという話はそう。

https://play.google.com/store/apps/details?id=io.github.takusan23.akaridroid

# ことの始まり
いままでは面倒くさがって`HEVC`（使って良いのかよくわからない）のみでしたが、`HEVC`と`AV1`を許可するようにコードを修正した訳とは・・！

時は2025年。**Pixel 10 シリーズ**のカメラアプリには**AV1**で保存する機能が搭載されている！！  
技術的には`Pixel 8`の時点でハードウェアエンコーダーが搭載されたので使えるハズですが、何故かその2年後のいま、`Pixel 10`まで実装されませんでした。  
（なお過去の端末にはバックポートされてないっぽい）

![camera_app](https://oekakityou.negitoro.dev/resize/56dbcf1f-2905-495f-8dd6-0e0c5a1bb981.png)

（小声、`AV1`より`HEVC`のが互換性が優れてる～説明はちょっと盛ってないか・・？）

で、これで撮影してみると確かに`AV1`でした。音声コーデックは`AAC`で、コンテナフォーマットは`MP4`でした。

![vlc](https://oekakityou.negitoro.dev/resize/53f581d0-f676-47c9-8cc7-1f34dbbe8874.png)

だから何という話ですが、このままでは負けてしまう（誰に？）と思い、  
急遽`AV1`での`10 ビット HDR 動画`の調査と、`MP4`だけだとまだ負けると思い（何に？）、`WebM`に入れるための調査を行いました。  
どーせ一生やらんやろって思ってたら`AV1`カメラ撮影機能来てしまった。

# AV1 と 10 ビット HDR 動画
**これは特にはないはずです。**

`MediaCodec`で`AV1`を指定して、そこに`10 ビット HDR`の映像（`Camera2 API`でカメラ映像とか）を渡せば、`AV1`でエンコードされた`10 ビット HDR 動画`のデータが取得できます。  
調べると仕様的には`VP9`でも`HDR 動画`が作れるらしいんですけど、`MediaCodec`がエラーを返してしまうので使えませんでした。。。これを`AV1`にすると動くんで間違ってはないはずなんですが。

というわけでエンコーダーに関しては問題無しで、`MP4`に書き込む処理も特になし。  
問題は`WebM`に書き込む方。

# WebM に 10 ビット HDR 動画を保存する
保存するためには、`HDR`用のパラメーターが必要です。というのも、`HDR`にはいくつか種類があって、種類に合わせてデコーダーを起動しないと色がかすれたりします。  
`HLG`や`HDR10`と呼ばれてるやつですね。

どこに保存するか、は、`WebM`の構造の説明が必要なのでそれが分かってないと何だかわからないと思うのですが、  
`Colour`親要素と、その中に入る`MatrixCoefficients`、`TransferCharacteristics`、`Primaries`が`HDR 動画`に必要な値のはずです。（インターネットの動画を見る限りこの3つが入ってた）

![webm](https://oekakityou.negitoro.dev/original/63c9f848-67c3-4b1b-87f1-a320f8087050.png)

| キー                    | 値                                                            |
|-------------------------|---------------------------------------------------------------|
| MatrixCoefficients      | `9` (`Rec.2020`)                                              |
| TransferCharacteristics | `18` (ガンマカーブが`HLG`) もしくは `16` (ガンマカーブが`PQ`) |
| Primaries               | `9` (`Rec.2020`)                                              |

`Android`に最初から`MediaMuxer`クラスがあり、同じく低レイヤー`API`である`MediaCodec`がエンコードした映像・音声を`MP4`や`WebM`に保存する担当を担います。  
が、このアプリでは`MP4`以外は自前で`WebM`を作っています。**バイト配列をいじくり回してます。**

https://takusan.negitoro.dev/posts/video_webm_spec/

`WebM`のパーサーを作ったんだから自前で作りたいという気持ちもありますが、どっちかと言うと`MediaMuxer`クラスの制約があり使えなかったが正解になります。  
なんかどっかで書いたような気もしないけど。これだと`AV1`コーデックが保存できない（`VP9`はもちろん行ける）んですよね。多分`AV1`的には`WebM`は非公式？な感じなのです。  
が、ブラウザで再生できちゃうので。実質入れられるみたいな

https://ja.wikipedia.org/wiki/AV1#標準化されていない仕様

なお再生に関しては`WebM + AV1 + HDR`が**ちゃんと眩しいです**。パラメーターちゃんと取れてるっぽい。そりゃそうか。

# おまけ
どうやら`PS5`の画面録画機能では`WebM + VP9`が**採用されている**らしいです。その上`HDR動画`で録画出来るっぽいです。（ガンマカーブは`PQ (ST2084)`らしい）  
持ってないので正しくは分からないです。

録画ファイルどこかからダウンロード出来たりしますかね、私も見てみたい`HDR`ゲームプレイ録画。  
録画くれるひと～

イケイケな？コーデックとコンテナを選んでいるので動画編集の際にはひと手間必要らしいです。  
私のアプリは`Android`に最初からある`MP4/WebM`パーサー（デマルチプレクサ）を使ってるので**いい感じに動くはずです**。

今回対応したので`HEVC`にもできるし`AV1 (mp4 か webm)`にも出来ます。`HDR`が保持された状態で！！  
`HEVC`が無理？じゃあ`AV1 + WebM`で再エンコードするから`Chrome`で開いて見て。ができます。

# おわりに
`Pixel 8 (2年前)(Tensor G3)`、`Pixel 10 Pro Fold (今年)(Tensor G5)`、`Xperia 1 VII (今年)(Snapdragon 8 Elite)`でそれぞれ動作確認している写真です。  
`HEVC + 60fps + 10ビットHDR`です。

![speedtest](https://oekakityou.negitoro.dev/resize/5eb53c25-f031-43fd-9903-e139e3c55ac9.jpg)

←`Pixel 8 Pro`↑`Pixel 10 Pro Fold`→`Xperia 1 VII`

【悲報】わたしのあぷり、なぜか2世代前の`Pixel 8 Pro`のほうが速い

スマホでゲームしないのでベンチマークスコアとかには全く興味がないのですが、、、、が、なんで？だ？