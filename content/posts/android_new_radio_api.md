---
title: 5Gãªã®ã«é€šä¿¡å§‹ã‚ã‚‹ã¨4Gã«ãªã‚‹ã‚„ã¤
created_at: 2021-12-30
tags:
- Android
- Kotlin
- 5G
---
ã©ã†ã‚‚ã“ã‚“ã°ã‚“ã‚ã€‚  
ã‚¦ãƒã¯ã‚‚ã†ã€å»¶æœŸã§ããªã„ã€‚ æ”»ç•¥ã—ã¾ã—ãŸã€‚  

http://www.cuffs.co.jp/products/enking/

ã¿ã‚“ãªå¯æ„›ã‹ã£ãŸã§ã™ã€‚  
ã‚·ãƒŠãƒªã‚ªãªã‚‰æœªæ¥ã¡ã‚ƒã‚“ã‹ãªãƒ¼

![Imgur](https://i.imgur.com/gn5s67t.png)
![Imgur](https://i.imgur.com/ofeHzOf.png)

ã§ã‚‚ã‚„ã£ã±åƒç´—ã•ã‚“ãŒå¯æ„›ã‹ã£ãŸã§ã™ã€‚

![Imgur](https://i.imgur.com/QfWM9eI.png)
![Imgur](https://i.imgur.com/fmBl3jo.png)

ã¨ã‚Šã‚ãˆãšã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°è¦‹ã¦ã»ã—ã„ã€ãƒ†ãƒ³ãƒè‰¯ãã¦è‰¯ã

## æœ¬é¡Œ
Pixel 6 Pro ã‚’æ›´æ–°ã—ãŸã‚‰ã¤ã„ã«docomoã®5Gã‚’æ´ã‚€ã‚ˆã†ã«ãªã£ãŸã€‚ã„ãˆãƒ¼ã„  
(ã¡ãªã¿ã«12æœˆã®ãƒ‘ãƒƒãƒã€ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿é€šä¿¡ã«å•é¡ŒãŒã‚ã‚‹ã¿ãŸã„ã§é…ä¿¡æ­¢ã¾ã£ã¦ã‚‹ã¿ãŸã„ã§ã™ã­ã€‚ã„ã¾ã‹ã‚‰é©ç”¨ã™ã‚‹ã®ã¯è¾ã‚ã¦1æœˆã®ãƒ‘ãƒƒãƒã¾ã§å¾…ã£ãŸã»ã†ãŒã„ã„ã¨æ€ã„ã¾ã™ã€‚)

ããƒ¼ã™ï¼šhttps://9to5google.com/2021/12/30/pixel-6-december-update-delay/

<img width="200" src="https://i.imgur.com/Mg1qpT3.png">

ã¨ã„ã†ã‚ã‘ã§ã€Android 11ã‹ã‚‰è¿½åŠ ã•ã‚ŒãŸ 5Gï¼ˆNR / New Radioï¼‰å‘ã‘ã®APIã‚’è©¦ã—ã¦ã¿ã‚‹

https://developer.android.com/about/versions/11/features/5g

(æ­£ç›´ç§ã‚‚ã‚ˆãã‚ã‹ã£ã¦ãªã„)

## ç’°å¢ƒ

| ãªã¾ãˆ   | ã‚ãŸã„                              |
|----------|-------------------------------------|
| ç«¯æœ«     | Google Pixel 6 Pro                  |
| Android  | 12                                  |
| ã‚­ãƒ£ãƒªã‚¢ | docomo (ã‚®ã‚¬ãƒ›ãƒ—ãƒ¬ãƒŸã‚¢å¥‘ç´„ã—ã¦ããŸ) |

## ãã®å‰ã«ï¼š5Gæ¥ãŸï¼é€šä¿¡å§‹ã‚ãŸã‚ï½—â†’4Gã«åˆ‡ã‚Šæ›¿ã‚ã‚‹
ä»•æ§˜ã§ã™ã€‚

https://www.nttdocomo.co.jp/area/5g/notice.html

### 5Gãªã®ã«4Gã«åˆ‡ã‚Šæ›¿ã‚ã‚‹ã®ã¯ãªãœï¼Ÿ
5Gã®å±•é–‹ã§ã¯ã€`ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ¼ãƒ³ (SA)`æ–¹å¼ã¨ã€`ãƒãƒ³ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ¼ãƒ³ (NSA)`æ–¹å¼ãŒã‚ã£ã¦ã€ç¾çŠ¶æ™®åŠã—ã¦ã‚‹5Gã¯`NSAæ–¹å¼`ã§ã™ã€‚   
å‰è€…ã®`SAæ–¹å¼`ã§ã¯ã€**5GåŸºåœ°å±€å˜ä½“**ã§å‹•ãã“ã¨ãŒã§ãã¾ã™ãŒã€  
å¾Œè€…ã®`NSAæ–¹å¼`ã§ã¯**å¾“æ¥ã®4GåŸºåœ°å±€è¨­å‚™(eNB)ã«5GåŸºåœ°å±€(gNB)ã‚’å°å…¥ã—ãŸç‰©ã§**ã€åˆ¶å¾¡ä¿¡å·(C-Plane)ã«4Gã®é›»æ³¢ã‚’åˆ©ç”¨ã—å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿è»¢é€(U-Plane)ã§ã¯5Gã®é›»æ³¢ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚   
4Gã¨5Gã‚’åŒæ™‚ã«åˆ©ç”¨ã™ã‚‹`EN-DC`ã£ã¦è¨€ã†æŠ€è¡“ã‚’æ¡ç”¨ã—ã¦ã„ã‚‹ãã†ã§ã™ã€‚ã“ã®å ´åˆã§ã¯4Gã‚’`ãƒã‚¹ã‚¿ãƒ¼ãƒãƒ¼ãƒ‰`ã€5Gã‚’`ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒãƒ¼ãƒ‰`ã¨å‘¼ã‚“ã§ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

æµã‚Œã¨ã—ã¦ã¯ã€
- 4GåŸºåœ°å±€ã¸å°å…¥ã—ãŸ5GåŸºåœ°å±€(NSAæ–¹å¼)ãŒã‚ã£ã¦ã€  
- ãã®4GåŸºåœ°å±€ã®åœå†…ã«å…¥ã£ãŸå ´åˆã«ã€5GåŸºåœ°å±€ã®å­˜åœ¨ãŒ4Gã®åˆ¶å¾¡ä¿¡å·ã§é€ã‚‰ã‚Œã¦æ¥ã‚‹ã€‚
    - ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒãƒ¼ãƒ‰ã®5GåŸºåœ°å±€ã¯è‡ªåˆ†ã®å­˜åœ¨ã‚’é€å‡ºã—ãªã„ã‚‰ã—ã„ï¼Ÿ(3GPP TS 37.340 7.1	System information handling)
- ã§ã‚‚å®Ÿéš›ã¯5GåŸºåœ°å±€ã®åœå†…ã«ã¯å…¥ã£ã¦ã„ãªã„ã€‚ã—ã‹ã—4Gï¼ˆã¨5Gã®åˆ¶å¾¡ä¿¡å·ï¼‰ã¯å±Šãã®ã§ã‚¢ãƒ³ãƒ†ãƒŠãƒ”ã‚¯ãƒˆã®éš£ã®ã‚¢ã‚¤ã‚³ãƒ³(RATè¡¨ç¤º)ãŒ5Gã«ãªã‚‹ã€‚
    - 5Gåœå†…ã«ã„ã‚Œã°4Gã®åˆ¶å¾¡ä¿¡å·ã‚’ã‚‚ã¨ã«æ¥ç¶šã—ã¦ãã‚Œã‚‹æ¨¡æ§˜ï¼ˆè¦èª¿æŸ»ï¼‰

è©³ã—ãçŸ¥ã‚ŠãŸã„å ´åˆã¯`EN-DC (E-UTRA-NR Dual Connectivity)`ã¨ã‹`ã‚¢ãƒ³ã‚«ãƒ¼ãƒãƒ³ãƒ‰`ã¨ã‹`5G NR NSA Call Flow`ã§æ¤œç´¢ã—ã¦ä¸‹ã•ã„ã€‚

3GPPã®è³‡æ–™ãŒè¦‹ãŸã„å ´åˆã¯ã“ã¡ã‚‰ã§ã™  
TS 37.340

https://portal.3gpp.org/desktopmodules/Specifications/SpecificationDetails.aspx?specificationId=3198

`Versions`ã‚¿ãƒ–ã¸ç§»å‹•ã—ã¦`Version`ã®ã¨ã“ã‚ã®ãƒªãƒ³ã‚¯ã‚’æŠ¼ã™ã¨DLã§ãã¾ã™ã€‚  
Googleç¿»è¨³ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŠ•ã’ã‚Œã°ç¿»è¨³ã—ã¦ãã‚Œã¾ã™ã€‚ï¼ˆãªãŠç†è§£ã§ãã‚‹ã¨ã¯è¨€ã£ã¦ã„ãªã„ï¼‰

### ãã†ã„ã†ã“ã¨ãªã®ã§
5Gå¯¾å¿œç«¯æœ«ã‚’SIMãƒ­ãƒƒã‚¯ãƒ•ãƒªãƒ¼ã§è²·ã†éš›ã¯ã€5Gã®å¯¾å¿œãƒãƒ³ãƒ‰ä»¥å¤–ã«ã‚‚4Gã®ãƒãƒ³ãƒ‰ã‚’ç¢ºèªã—ãªã„ã¨ã„ã‘ã¾ã›ã‚“ã€‚  
`EN-DCçµ„ã¿åˆã‚ã›`ã¨ã‹ã§æ¤œç´¢ã™ã‚Œã°4Gã®ãƒãƒ³ãƒ‰ã¨5Gã®ãƒãƒ³ãƒ‰ã®çµ„ã¿åˆã‚ã›ãŒå‡ºã¦ãã‚‹ã®ã§ã„ã„ã¨æ€ã„ã¾ã™ã€‚  
(ã©ã†ã§ã‚‚ã„ã„ã‚“ã ã‘ã©docomoã®5G Sub-6ã§ä½¿ã£ã¦ã‚‹`n79`ã£ã¦SIMãƒ•ãƒªãƒ¼ç«¯æœ«ã ã¨å…¨ç„¶å¯¾å¿œã—ã¦ãªããªã„ï¼Ÿ)

## é©å½“ã«ã‚¢ãƒ—ãƒªã‚’ä½œã‚‹

### ä½¿ã†ãƒ¡ã‚½ãƒƒãƒ‰

- `ConnectivityManager#registerDefaultNetworkCallback()`
    - ã©ã†ã‚„ã‚‰ã“ã‚Œã§`å¾“é‡åˆ¶ or å®šé¡åˆ¶`ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®æ¤œå‡ºãŒã§ãã‚‹ã‚‰ã—ã„ï¼ˆç„¡ç†ã˜ã‚ƒã­ï¼Ÿï¼‰
        - ä½¿ã„æ”¾é¡Œã‹ä¸Šé™ä»˜ãã®ãƒ—ãƒ©ãƒ³ã‹ã¿ãŸã„ãªï¼Ÿ
- `TelephonyManager#listen()`ã¨`onDisplayInfoChanged()`
    - ã“ã‚Œã§5GãŒ`Sub-6 or ãƒŸãƒªæ³¢`ã®ã©ã£ã¡ãªã®ã‹ãŒæ¤œå‡ºã§ãã‚‹ã¿ãŸã„ã€‚
    - ã‚¢ãƒ³ãƒ†ãƒŠãƒ”ã‚¯ãƒˆğŸ“¶ã®éš£ã®`5G`ã€`4G+`ã¨åŒã˜ã®ãŒå–ã‚Œã‚‹ã£ã½ã„
- `TelephonyManager#listen()`ã¨`onDisplayInfoChanged()`
    - æ¥ç¶šä¸­ãƒãƒ³ãƒ‰ãŒçŸ¥ã‚ŠãŸã„

### app/build.gradle

`Activity Result API`ã‚’ä½¿ã„ãŸã„ã®ã§Activityã¨Fragmentã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚ã’ã¾ã™ã€‚  
ã‚ã¨`ViewBinding`ã‚‚ä½¿ã„ãŸã„ã®ã§æœ‰åŠ¹ã«ã—ã¾ã™ã€‚

```java
plugins {
    id 'com.android.application'
    id 'kotlin-android'
}

android {
    compileSdk 31

    defaultConfig {
        applicationId "io.github.takusan23.newradioapichecker"
        minSdk 30
        targetSdk 31
        versionCode 1
        versionName "1.0"

        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
    }

    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }
    buildFeatures {
        viewBinding true
    }
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }
    kotlinOptions {
        jvmTarget = '1.8'
    }
}

dependencies {

    implementation "androidx.activity:activity:1.4.0"
    implementation "androidx.fragment:fragment-ktx:1.4.0"

    implementation 'androidx.core:core-ktx:1.7.0'
    implementation 'androidx.appcompat:appcompat:1.4.0'
    implementation 'com.google.android.material:material:1.4.0'
    implementation 'androidx.constraintlayout:constraintlayout:2.1.2'
    testImplementation 'junit:junit:4.+'
    androidTestImplementation 'androidx.test.ext:junit:1.1.3'
    androidTestImplementation 'androidx.test.espresso:espresso-core:3.4.0'
}
```

### AndroidManifest.xml
é›»æ³¢çŠ¶æ…‹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ä½ç½®æƒ…å ±ã¨ã‹ç™ºä¿¡æ¨©é™ã¨ã‹ä½™è¨ˆãªã‚‚ã‚“ä»˜ã„ã¦ãã¾ã™ãŒä»•æ–¹ãªã„ã€‚

```xml
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
<uses-permission android:name="android.permission.READ_PHONE_STATE" />
```

### activity_main.xml

```xml
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    tools:context=".MainActivity">

    <TextView
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:padding="10dp"
        android:text="å¾“é‡åˆ¶ãƒã‚§ãƒƒã‚¯"
        android:textSize="20sp" />

    <TextView
        android:id="@+id/activity_main_metered_textview"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:gravity="end"
        android:padding="10dp"
        android:text="---"
        android:textSize="20sp" />

    <TextView
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:padding="10dp"
        android:text="5Gã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯"
        android:textSize="20sp" />

    <TextView
        android:id="@+id/activity_main_new_radio_textview"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:gravity="end"
        android:padding="10dp"
        android:text="---"
        android:textSize="20sp" />

    <TextView
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:padding="10dp"
        android:text="æ¥ç¶šä¸­ãƒãƒ³ãƒ‰"
        android:textSize="20sp" />

    <TextView
        android:id="@+id/activity_main_band_textview"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:gravity="end"
        android:padding="10dp"
        android:text="---"
        android:textSize="20sp" />

</LinearLayout>
```

### MainActivity.kt

```kotlin
class MainActivity : AppCompatActivity() {

    private val connectivityManager by lazy { getSystemService(CONNECTIVITY_SERVICE) as ConnectivityManager }
    private val telephonyManager by lazy { getSystemService(Context.TELEPHONY_SERVICE) as TelephonyManager }
    private val viewBinding by lazy { ActivityMainBinding.inflate(layoutInflater) }

    // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è§£é™¤ç”¨
    private var connectivityManagerCallback: ConnectivityManager.NetworkCallback? = null
    private var phoneStateListener: PhoneStateListener? = null
    private var telephonyCallback: TelephonyCallback? = null

    private val permissionRequest = registerForActivityResult(ActivityResultContracts.RequestMultiplePermissions()) { result ->
        if (result.all { it.value }) {
            startListen()
        }
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(viewBinding.root)

        // æ¨©é™ç¢ºèª
        if (isGranted()) {
            // ã‚ã‚‹ã®ã§ç›£è¦–é–‹å§‹
            startListen()
        } else {
            // ãªã„
            permissionRequest.launch(arrayOf(Manifest.permission.ACCESS_FINE_LOCATION, Manifest.permission.READ_PHONE_STATE))
        }
    }

    private fun startListen() {
        listenUnlimitedNetwork {
            viewBinding.activityMainMeteredTextview.text = if (it) "ç„¡åˆ¶é™ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶š" else "ä¸Šé™ã‚ã‚Šã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶š"
        }
        listenNewRadio(
            onCellInfoCallback = {
                viewBinding.activityMainBandTextview.text = when (it) {
                    is CellInfoLte -> """LTE
æ¥ç¶šä¸­ãƒãƒ³ãƒ‰ï¼š${it.cellIdentity.bands.map { it.toString() }} (${it.cellIdentity.earfcn})"""
                    is CellInfoNr -> """5G
æ¥ç¶šä¸­ãƒãƒ³ãƒ‰ï¼š${(it.cellIdentity as CellIdentityNr).bands.map { it.toString() }} (${(it.cellIdentity as CellIdentityNr).nrarfcn})"""
                    else -> "ãã‚Œä»¥å¤–"
                }
            },
            onDisplayInfoCallback = {
                viewBinding.activityMainNewRadioTextview.text = when (it.overrideNetworkType) {
                    TelephonyDisplayInfo.OVERRIDE_NETWORK_TYPE_LTE_ADVANCED_PRO -> "LTE Advanced Proï¼ˆ5Geï¼‰"
                    TelephonyDisplayInfo.OVERRIDE_NETWORK_TYPE_LTE_CA -> "LTE ã‚­ãƒ£ãƒªã‚¢ã‚¢ã‚°ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³"
                    TelephonyDisplayInfo.OVERRIDE_NETWORK_TYPE_NR_NSA -> "5G Sub-6 ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯"
                    TelephonyDisplayInfo.OVERRIDE_NETWORK_TYPE_NR_NSA_MMWAVE -> "5G ãƒŸãƒªæ³¢ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ (éæ¨å¥¨)"
                    TelephonyDisplayInfo.OVERRIDE_NETWORK_TYPE_NR_ADVANCED -> "5G ãƒŸãƒªæ³¢ (ã‚‚ã—ãã¯ãã‚ŒåŒç­‰ã®) ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯"
                    else -> "ãã‚Œä»¥å¤–"
                }
            }
        )
    }

    private fun isGranted(): Boolean {
        val fineLocation = ContextCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION)
        val readPhoneState = ContextCompat.checkSelfPermission(this, Manifest.permission.READ_PHONE_STATE)
        return (fineLocation == PackageManager.PERMISSION_GRANTED) && (readPhoneState == PackageManager.PERMISSION_GRANTED)
    }

    private fun listenNewRadio(
        onCellInfoCallback: (CellInfo) -> Unit,
        onDisplayInfoCallback: (TelephonyDisplayInfo) -> Unit,
    ) {
        // Android 12ã‚ˆã‚Šæ›¸ãæ–¹ãŒå¤‰ã‚ã£ãŸ
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
            telephonyCallback = object : TelephonyCallback(), TelephonyCallback.DisplayInfoListener, TelephonyCallback.CellInfoListener {
                /** å®Ÿéš›ã®çŠ¶æ…‹ */
                override fun onCellInfoChanged(cellInfo: MutableList<CellInfo>) {
                    onCellInfoCallback(cellInfo[0])
                }

                /** ã‚¢ãƒ³ãƒ†ãƒŠãƒ”ã‚¯ãƒˆã¨åŒã˜ã‚„ã¤ */
                override fun onDisplayInfoChanged(telephonyDisplayInfo: TelephonyDisplayInfo) {
                    onDisplayInfoCallback(telephonyDisplayInfo)
                }
            }
            telephonyManager.registerTelephonyCallback(mainExecutor, telephonyCallback!!)
        } else {
            phoneStateListener = object : PhoneStateListener() {

                @SuppressLint("MissingPermission")
                override fun onCellInfoChanged(cellInfo: MutableList<CellInfo>?) {
                    super.onCellInfoChanged(cellInfo)
                    cellInfo?.get(0)?.let { onCellInfoCallback(it) }
                }

                @SuppressLint("MissingPermission")
                override fun onDisplayInfoChanged(telephonyDisplayInfo: TelephonyDisplayInfo) {
                    super.onDisplayInfoChanged(telephonyDisplayInfo)
                    onDisplayInfoCallback(telephonyDisplayInfo)
                }
            }
            telephonyManager.listen(phoneStateListener!!, PhoneStateListener.LISTEN_DISPLAY_INFO_CHANGED or PhoneStateListener.LISTEN_CELL_INFO)
        }
    }

    private fun listenUnlimitedNetwork(onResult: (Boolean) -> Unit) {
        connectivityManagerCallback = object : ConnectivityManager.NetworkCallback() {
            override fun onCapabilitiesChanged(network: Network, networkCapabilities: NetworkCapabilities) {
                super.onCapabilitiesChanged(network, networkCapabilities)
                // ç„¡åˆ¶é™ãƒ—ãƒ©ãƒ³ã‚’å¥‘ç´„ã—ã¦ã„ã‚‹å ´åˆã¯true
                val isUnlimited = networkCapabilities.hasCapability(NetworkCapabilities.NET_CAPABILITY_NOT_METERED) ||
                        networkCapabilities.hasCapability(NetworkCapabilities.NET_CAPABILITY_TEMPORARILY_NOT_METERED)
                onResult(isUnlimited)
            }
        }
        connectivityManager.registerDefaultNetworkCallback(connectivityManagerCallback!!)
    }

    override fun onDestroy() {
        super.onDestroy()
        connectivityManagerCallback?.let { connectivityManager.unregisterNetworkCallback(it) }
        phoneStateListener?.let { telephonyManager.listen(it, PhoneStateListener.LISTEN_NONE) }
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
            telephonyCallback?.let { telephonyManager.unregisterTelephonyCallback(it) }
        }
    }

}
```

### çµæœ

å¯’ã„ä¸­ãƒ‰ã‚³ãƒ¢ã‚·ãƒ§ãƒƒãƒ—ã®è¿‘ãã‚’ãƒ•ãƒ©ãƒ•ãƒ©ã—ã¦5Gã®é›»æ³¢ã‚’æ„Ÿã˜ã¦ãã¾ã—ãŸã€‚(ãƒ‰ã‚³ãƒ¢ã‚·ãƒ§ãƒƒãƒ—ã«ã¯è²´é‡ãª5GãƒŸãƒªæ³¢ã‚¢ãƒ³ãƒ†ãƒŠãŒã‚ã‚‹ã€‚ã™ã¹ã¦ã®åº—èˆ—ã«ã¯ç„¡ã„ã£ã½ã„ï¼Ÿ)

<img width="200" src="https://i.imgur.com/Mg1qpT3.png">
<img width="200" src="https://i.imgur.com/J2BomtM.png">
<img width="200" src="https://i.imgur.com/TcmirVd.png">
<img width="200" src="https://i.imgur.com/PhYA35b.png">

- `ConnectivityManager#registerDefaultNetworkCallback()`
    - ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿æ¥ç¶šä¸­ã¯å¸¸ã«å¾“é‡åˆ¶ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ¤å®šã ã£ãŸ
        - ãªã‚“ã‹è¨­å®šãŒå¿…è¦ãªã®ï¼Ÿ
- `TelephonyManager#listen()`ã¨`onDisplayInfoChanged()`
    - `ãƒŸãƒªæ³¢`ã§ã‚‚å¤‰ã‚ã‚‰ãšã€`Sub-6`åˆ¤å®šã ã£ãŸã€‚
    - `ã‚¢ãƒ³ã‚«ãƒ¼ãƒãƒ³ãƒ‰åœå†…`ã®å ´åˆã§ã‚‚`Sub-6`åˆ¤å®šã ã£ãŸã€‚
- `TelephonyManager#listen()`ã¨`onDisplayInfoChanged()`
    - ã‚¢ãƒ³ã‚«ãƒ¼ãƒãƒ³ãƒ‰æ™‚ã¯`CellInfoLte`ã€5G(Sub-6/NR)ã®å ´åˆã¯`CellIdentityNr`ãŒè²°ãˆã‚‹
        - ã‚ˆã£ã¦`Sub-6`or`ãƒŸãƒªæ³¢`or`ã‚¢ãƒ³ã‚«ãƒ¼ãƒãƒ³ãƒ‰`ã®æ¤œå‡ºã«ã¯ã“ã£ã¡ã‚’åˆ©ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã£ã¦ã“ã¨ã§ã™ã­ï¼

## Sub-6 ã‹ ãƒŸãƒªæ³¢ ã‹åˆ¤å®šã™ã‚‹æ–¹æ³•

`NRARFCN`ã®æ•°å­—ãŒ`2054166`ä»¥ä¸Šã®å ´åˆã¯å¤šåˆ†ãƒŸãƒªæ³¢ã§ã™(5Gãƒãƒ³ãƒ‰`n257`ä»¥ä¸Š)

ã¨ã„ã†ã‚ã‘ã§ã€`startListen é–¢æ•°`ã‚’æ›¸ãæ›ãˆã‚Œã°5G ãƒŸãƒªæ³¢ã€5G Sub-6ã®æ¤œçŸ¥ã‚‚å‡ºæ¥ã‚‹ã¯ãšã§ã™ã€‚

```kotlin
    private fun startListen() {
        listenUnlimitedNetwork {
            viewBinding.activityMainMeteredTextview.text = if (it) "ç„¡åˆ¶é™ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶š" else "ä¸Šé™ã‚ã‚Šã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶š"
        }
        listenNewRadio(
            onCellInfoCallback = {
                viewBinding.activityMainBandTextview.text = when (it) {
                    is CellInfoLte -> """LTE
æ¥ç¶šä¸­ãƒãƒ³ãƒ‰ï¼š${it.cellIdentity.bands.map { it.toString() }} (${it.cellIdentity.earfcn})"""
                    is CellInfoNr -> """5G
æ¥ç¶šä¸­ãƒãƒ³ãƒ‰ï¼š${(it.cellIdentity as CellIdentityNr).bands.map { it.toString() }} (${(it.cellIdentity as CellIdentityNr).nrarfcn})
${if ((it.cellIdentity as CellIdentityNr).nrarfcn > 2054166) "ãƒŸãƒªæ³¢ã«æ¥ç¶šä¸­" else "Sub-6ã«æ¥ç¶šä¸­"}
"""
                    else -> "ãã‚Œä»¥å¤–"
                }
            },
            onDisplayInfoCallback = {
                viewBinding.activityMainNewRadioTextview.text = when (it.overrideNetworkType) {
                    TelephonyDisplayInfo.OVERRIDE_NETWORK_TYPE_LTE_ADVANCED_PRO -> "LTE Advanced Proï¼ˆ5Geï¼‰"
                    TelephonyDisplayInfo.OVERRIDE_NETWORK_TYPE_LTE_CA -> "LTE ã‚­ãƒ£ãƒªã‚¢ã‚¢ã‚°ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³"
                    TelephonyDisplayInfo.OVERRIDE_NETWORK_TYPE_NR_NSA -> "5G Sub-6 ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯"
                    TelephonyDisplayInfo.OVERRIDE_NETWORK_TYPE_NR_NSA_MMWAVE -> "5G ãƒŸãƒªæ³¢ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ (éæ¨å¥¨)"
                    TelephonyDisplayInfo.OVERRIDE_NETWORK_TYPE_NR_ADVANCED -> "5G ãƒŸãƒªæ³¢ (ã‚‚ã—ãã¯ãã‚ŒåŒç­‰ã®) ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯"
                    else -> "ãã‚Œä»¥å¤–"
                }
            }
        )
    }
```

## ã‚¢ãƒ³ã‚«ãƒ¼ãƒãƒ³ãƒ‰ã‹ã©ã†ã‹ã‚’åˆ¤æ–­ã™ã‚‹æ–¹æ³•

`CellInfo`ã¨`TelephonyDisplayInfo`ã‹ã‚‰åˆ¤æ–­ã§ãã¾ã™

```kotlin
    private fun listenNewRadio(
        onCellInfoCallback: (CellInfo) -> Unit,
        onDisplayInfoCallback: (TelephonyDisplayInfo) -> Unit,
        onAnchorBandCallback: (Boolean) -> Unit,
    ) {

        // onCellInfoChanged onDisplayInfoChanged ã®çµæœã‚’ä¸€æ™‚çš„ã«æŒã£ã¦ãŠã
        var tempCellInfo: CellInfo? = null
        var tempTelephonyDisplayInfo: TelephonyDisplayInfo? = null

        // ã‚¢ãƒ³ã‚«ãƒ¼ãƒãƒ³ãƒ‰ã‹ã©ã†ã‹ã‚’é€ã‚‹
        fun checkAnchorBand() {
            if (tempCellInfo == null && tempTelephonyDisplayInfo == null) return
            // CellInfoãŒLTEã®ã‚‚ã®ã§ã€å®Ÿéš›ã«è¡¨ç¤ºã—ã¦ã„ã‚‹ã‚¢ã‚¤ã‚³ãƒ³ãŒ5Gã®å ´åˆã¯ã‚¢ãƒ³ã‚«ãƒ¼ãƒãƒ³ãƒ‰
            val isAnchorBand = tempCellInfo is CellInfoLte && tempTelephonyDisplayInfo?.overrideNetworkType == TelephonyDisplayInfo.OVERRIDE_NETWORK_TYPE_NR_NSA
            onAnchorBandCallback(isAnchorBand)
        }

        // Android 12ã‚ˆã‚Šæ›¸ãæ–¹ãŒå¤‰ã‚ã£ãŸ
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
            telephonyCallback = object : TelephonyCallback(), TelephonyCallback.DisplayInfoListener, TelephonyCallback.CellInfoListener {
                /** å®Ÿéš›ã®çŠ¶æ…‹ */
                override fun onCellInfoChanged(cellInfo: MutableList<CellInfo>) {
                    onCellInfoCallback(cellInfo[0])
                    tempCellInfo = cellInfo[0]
                    checkAnchorBand()
                }

                /** ã‚¢ãƒ³ãƒ†ãƒŠãƒ”ã‚¯ãƒˆã¨åŒã˜ã‚„ã¤ */
                override fun onDisplayInfoChanged(telephonyDisplayInfo: TelephonyDisplayInfo) {
                    onDisplayInfoCallback(telephonyDisplayInfo)
                    tempTelephonyDisplayInfo = telephonyDisplayInfo
                    checkAnchorBand()
                }
            }
            telephonyManager.registerTelephonyCallback(mainExecutor, telephonyCallback!!)
        } else {
            phoneStateListener = object : PhoneStateListener() {

                @SuppressLint("MissingPermission")
                override fun onCellInfoChanged(cellInfo: MutableList<CellInfo>?) {
                    super.onCellInfoChanged(cellInfo)
                    cellInfo?.get(0)?.let { onCellInfoCallback(it) }
                    tempCellInfo = cellInfo?.get(0)
                    checkAnchorBand()
                }

                @SuppressLint("MissingPermission")
                override fun onDisplayInfoChanged(telephonyDisplayInfo: TelephonyDisplayInfo) {
                    super.onDisplayInfoChanged(telephonyDisplayInfo)
                    onDisplayInfoCallback(telephonyDisplayInfo)
                    tempTelephonyDisplayInfo = telephonyDisplayInfo
                    checkAnchorBand()
                }
            }
            telephonyManager.listen(phoneStateListener!!, PhoneStateListener.LISTEN_DISPLAY_INFO_CHANGED or PhoneStateListener.LISTEN_CELL_INFO)
        }
    }
```

é–¢æ•°ã‚’å‘¼ã¶å´ã¯ã“ã‚“ãªé¢¨ã«

```kotlin
    private fun startListen() {
        listenUnlimitedNetwork {
            viewBinding.activityMainMeteredTextview.text = if (it) "ç„¡åˆ¶é™ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶š" else "ä¸Šé™ã‚ã‚Šã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶š"
        }
        listenNewRadio(
            onCellInfoCallback = {
                viewBinding.activityMainBandTextview.text = when (it) {
                    is CellInfoLte -> """LTE
æ¥ç¶šä¸­ãƒãƒ³ãƒ‰ï¼š${it.cellIdentity.bands.map { it.toString() }} (${it.cellIdentity.earfcn})"""
                    is CellInfoNr -> """5G
æ¥ç¶šä¸­ãƒãƒ³ãƒ‰ï¼š${(it.cellIdentity as CellIdentityNr).bands.map { it.toString() }} (${(it.cellIdentity as CellIdentityNr).nrarfcn})
${if ((it.cellIdentity as CellIdentityNr).nrarfcn > 2054166) "ãƒŸãƒªæ³¢ã«æ¥ç¶šä¸­" else "Sub-6ã«æ¥ç¶šä¸­"}"""
                    else -> "ãã‚Œä»¥å¤–"
                }
            },
            onDisplayInfoCallback = {
                viewBinding.activityMainNewRadioTextview.text = when (it.overrideNetworkType) {
                    TelephonyDisplayInfo.OVERRIDE_NETWORK_TYPE_LTE_ADVANCED_PRO -> "LTE Advanced Proï¼ˆ5Geï¼‰"
                    TelephonyDisplayInfo.OVERRIDE_NETWORK_TYPE_LTE_CA -> "LTE ã‚­ãƒ£ãƒªã‚¢ã‚¢ã‚°ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³"
                    TelephonyDisplayInfo.OVERRIDE_NETWORK_TYPE_NR_NSA -> "5G Sub-6 ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯"
                    TelephonyDisplayInfo.OVERRIDE_NETWORK_TYPE_NR_NSA_MMWAVE -> "5G ãƒŸãƒªæ³¢ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ (éæ¨å¥¨)"
                    TelephonyDisplayInfo.OVERRIDE_NETWORK_TYPE_NR_ADVANCED -> "5G ãƒŸãƒªæ³¢ (ã‚‚ã—ãã¯ãã‚ŒåŒç­‰ã®) ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯"
                    else -> "ãã‚Œä»¥å¤–"
                }
            },
            onAnchorBandCallback = {
                // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«TextViewè¿½åŠ ã—ã¦ãŠã„ã¦ï¼
                viewBinding.activityMainAnchorBandTextview.text = if (it) "ã‚¢ãƒ³ã‚«ãƒ¼ãƒãƒ³ãƒ‰æ¥ç¶šä¸­" else "4Gæ¥ç¶šä¸­ã€ã‚‚ã—ãã¯ã‚¢ãƒ³ã‚«ãƒ¼ãƒãƒ³ãƒ‰ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"
            }
        )
    }
```

## ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰
ã©ã†ãï½

https://github.com/takusan23/NewRadioAPIChecker

# çµ‚ã‚ã‚Šã«
ã‚¢ãƒ³ã‚«ãƒ¼ãƒãƒ³ãƒ‰ãƒã‚§ãƒƒã‚«ãƒ¼ä½œã‚Šã¾ã—ãŸã€‚ä½œã£ãŸã‚“ã ã‘ã©ãªã‚“ã‹docomoãªã®ã«`ãƒãƒ³ãƒ‰ï¼šn77`ã¨ã‹è¡¨ç¤ºã™ã‚‹ã—ãªã‚“ã‹å¼·åˆ¶çµ‚äº†ã™ã‚‹ã—ã¦é©å½“ã ã‘ã©ã©ã†ãã€‚

(PlayStoreã£ã¦å¹´æœ«å¹´å§‹ã‚‚å¯©æŸ»ã—ã¦ã‚‹ã‚“ã‹ãƒ»ãƒ»ãƒ»ï¼ŸãŠç–²ã‚Œæ§˜ã§ã™)

- PlayStore
    - https://play.google.com/store/apps/details?id=io.github.takusan23.newradiosupporter
    - Android 11 ä»¥é™
- ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰
    - https://github.com/takusan23/NewRadioSupporter

ãã†ã„ãˆã°docomoã‚‚ãªã‚“ã¡ã‚ƒã£ã¦5Gï¼ˆ4Gå‘¨æ³¢æ•°ã‚’è»¢ç”¨ï¼‰ã®å§¿å‹¢ã‚’è¦‹ã›ãŸã¿ãŸã„ã§ã™ã‚ˆã€‚docomoã¯ã‚„ã‚‰ãªã„é›°å›²æ°—ï¼ˆãªãœã‹å¤‰æ›ã§ããªã„ï¼‰å‡ºã—ã¦ãŸã®ã«ãƒ»ãƒ»ãƒ»