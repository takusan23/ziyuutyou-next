---
title: 自作動画編集アプリで実際に動画編集してみた感想
created_at: 2024-10-15
tags:
- その他
---
どうもこんばんわ。  
`satellite`な`iPhone`です。ちなヨドバシ。  

![Imgur](https://imgur.com/I71wyPv.png)

ところでカメラコントロールって`無印 iPhone`にもあったんですね。  
`Dynamic Island`といい`Lightning 廃止`といいまずは`Pro`から投入されてたので、今回も無印は後回しだと思ってた。

*Apple Intelligence は来年まで来ません・・・*

# 本題
前作った自作の動画編集アプリ（大した機能はない）で動画を作ってみたので感想。  
ドッグフーディング

# 作った動画

https://www.nicovideo.jp/watch/sm44212192

<script type="application/javascript" src="https://embed.nicovideo.jp/watch/sm44212192/script?w=640&h=360"></script><noscript><a href="https://www.nicovideo.jp/watch/sm44212192">【ゆっくり実況】自作MODを新しいバージョンに追従するまで（1.20.6）</a></noscript>

`1080p（1920x1080）`の、`60fps`なので、なかなか豪華。  

動画の内容は前記事にした、マイクラ`1.20.6`へ`自作のMOD`の対応して、テストプレイをするという内容。  
https://takusan.negitoro.dev/posts/minecraft_mod_1_20_6_migration/

記事の中にはありませんが、このあとのテストプレイを録画していたので、、、

# 風景
これがタイムライン、  
大体パソコンの`YMM3`とかもこんな感じだと思う。

![Imgur](https://imgur.com/jCT4yM9.png)

![Imgur](https://imgur.com/FQOOKKG.png)

![Imgur](https://imgur.com/tsbBAAh.png)

ただ、このアプリにはゆっくり音声を生成する機能がないので、上にゆっくり音声を生成できるアプリを**ポップアップで表示**させている。  
この手のポップアップで上に重ねて表示する機能、`Xperia`以外にもあったりするけどいまいち使い道が分からんかった。けどここで使うのかって気持ちになった。

`Xperia`のスモールアプリ、いつの間にかなくなってしまったけど好きなアプリをオーバーレイできるようになって再登場。

へへへ、アップロードします。  
いつもはパソコンで作るのでなんか新鮮

![Imgur](https://imgur.com/OAT3Hs1.png)

![Imgur](https://imgur.com/W90Y5lz.png)

# エンコード時間
`1080p`、`60fps`で、`27分`くらいの動画ですが、エンコードにかかった時間は**6、7時間**くらいでした。（！！！？）  
**うーん？時間かかり過ぎでは？**。  

ちなみに、スマホのスペックは去年（2023年）のハイエンド`Xperia 1 V`で、`Snapdragon 8 Gen 2`で十二分な性能なはず。  

やっぱり動画フレームを取り出して`Canvas`に書いてるのが相当遅い。  
動画フレームを直接`OpenGL ES`のテクスチャとして使う機能があるので、もうそれを使うべきな気がする。後で話します。  

# 感想

## 積み上げたコミット
動画編集中にいろいろ改善点が見つかって、それらの機能を作るためコミットを積みました。  
**もうパソコンで動画作れ**

- タイムラインがおもすぎて`Compose`の`Strong Skipping Mode`を有効に
    - 見えない部分まで描画しているという、実装が悪いのであんまり改善されませんでしたが
- 編集中プロジェクトを持ち出せる機能
- 音声素材のデコード結果を持ち回すように
- デコーダーの同時利用上限に引っかからないよう制限を
- などなど

まだリリースできてない機能があってあれ、出します。

## 追記（2024/12/27）プレビューが結構現実的な速度で動くように
`OpenGL ES`の中で、動画素材からフレームを取り出し、描画し、動画編集のフレームを生成するようにしました。  
おかげでかなりプレビューが現実的な速度で動くようになった気がします。（動画プレイヤーほどヌルヌルじゃないです。流石に）

アップデートをストアに公開したので試せます。

## 今のプレビューだと使い物にならない
**今のところプレビューはまじで使い物にならない。**  
**ちなみに、動画素材さえなければそんなに遅くないはず。文字と画像だけみたいな。あと音声か。**  

動画素材からフレームを取り出すのが遅すぎる。  
作ってた当時は、`OpenGL ES`は難しいから、極力避けて`Canvas`でなんとかしようとしてた。  
いや、詳しく言うと`Canvas`で書いて`Bitmap`にして`OpenGL ES`で描画し、エンコードしてた。`Android の エンコーダー（MediaCodec）`は`Canvas`や`Bitmap`を受け入れず、`OpenGL ES`で描画してエンコーダーに渡すのが正攻法っぽい。つまり`OpenGL ES`は使ってはいたんだけど、難しいから最小限にしてた。複雑すぎる。

そのため、動画素材も、フレームを一枚一枚取り出して、`Canvas`に書いていた。  
先述の通り複雑にしたくなかったのと、連続してフレームを取り出す処理を自前で書いたので（`MediaMetadataRetriever`より速くなるように）、そんなに影響がないはずだと思ってたんですよ！。  
`OpenGL ES`で複雑になるくらいなら速度を犠牲にした。

が。いくら何でも遅すぎる。プレビュー出来ないのは痛い。`OpenGL ES`で作り直そうかなって。まだ草案しか考えてないけど。  
かわりに`SurfaceTexture`っていう、`OpenGL ES`で動画やカメラの映像をそのままテクスチャとして使うクラスがあるので、これに乗っかるようにしたい。（何回かこのブログでも登場してます）  

複雑になるんだけど、  
[前と後ろのカメラを同時に利用し、OpenGL ES で映像を重ねて表示するアプリ](https://play.google.com/store/apps/details?id=io.github.takusan23.komadroid)  
とか、  
[単一画面の画面共有に対応したミラーリングアプリ](https://play.google.com/store/apps/details?id=io.github.takusan23.zeromirror)  
とかで、`OpenGL ES`を使っているので、（まあ簡単なシェーダーとコピペなんですが）  
ちょっとだけ知見が溜まってきた。これなら複雑な部分を隠蔽しつつ、動画素材だとしてもフレームをテクスチャとして使えるため`OpenGL ES`の高速な描画の恩恵が受けれられるはず。

あと、書き直したい理由がもう一個あって、`10ビット HDR`動画の編集が`OpenGL ES`だと実現できそう？。  
今のプレビューや動画のエンコードは`Canvas`で書いて`Bitmap`にしてるんですが、`Canvas / Bitmap`って`10ビット`というか`RGBA_1010102`みたいなのって出来るの？  
（まあ仮に出来たところで、動画フレームを`Bitmap`で取り出して`Canvas`に書くのがするのが遅いんで結局書き直したほうが良さそ）

`Android`の`Camera2 API`のサンプルが`OpenGL ES 3`で書かれてて、ちょうど`HDR`のカメラ映像のテクスチャを描画しているのがこの辺。  
https://github.com/android/camera-samples/blob/a07d5f1667b1c022dac2538d1f553df20016d89c/Camera2Video/app/src/main/java/com/example/android/camera2/video/HardwarePipeline.kt#L107

`HDR`、`Pixel 8 Pro`のクソ明るい画面で見ると結構感動するしで、いつかやってみたい。  

## Pixel 8 Pro でエンコードに失敗し続ける
ちなみにこの通知は実装してないです。  
失敗し続けてて調査のため付け焼き刃的な感じでエラー通知を出すようにしただけで、機能としては存在してないです、、

![Imgur](https://imgur.com/R2fSZ6Z.png)

![Imgur](https://imgur.com/QmefCKj.png)

ベンチマークのために、`Pixel 8 Pro`でも同じ動画のエンコードをやってみたんだけど、エンコーダーにフレームを渡す`OpenGL ES`の部分でときたま落ちてしまい、数回試してみたけどだめだった。しかも失敗してる箇所が毎回違って謎。  
`Snapdragon`搭載の`Xperia`だと普通に成功したので、よく分からん、、、こっちでも落ちるんだったら私のコードが悪いんだけどさ。

原因はわからないですが、考えられるのが、

- `Android`が`Beta`版だから？の可能性
- `Google Pixel`シリーズは`Exynos`系の`SoC`で、その中にある`Mali GPU`の`OpenGL ES`実装がイマイチな可能性
- `Snapdragon`の`Adreno GPU`が大目に見ているだけ。たまたま動いている可能性

ん～～～

## 起動に失敗する
動画編集が中盤くらいに差し掛かった頃。  
アプリが起動しません。しばらくすると落ちます。

というわけで見てみたところ、音声素材を合成するための作業で必要な、音声のハードウェアデコーダーが**起動上限か何かに引っかかって**エラーになってた。  
音声は最初にデコードして、同じ時間に鳴らすべき音を合成（足し算）してるんだけど、**このデコード処理が起動するたびに走ってた**。

というわけで、音声素材はデコードしたら、消さずにそのまま使い回すようにしました。ファイルのハッシュを名前にするとかやったはずです。  
（そして書いてて気付いた、これ消す方法ないわ）

## ドラッグアンドドロップがほしい
一部の写真アプリや、ファイルマネージャーはドラッグアンドドロップに対応してて、このままメーラーやメッセージアプリへドロップするとそのまま添付できる。  
やっぱり狙った写真を探すのは、`フォトピッカー`よりもアプリのほうが速いんだよな。スクロールだって簡単だし。  

私のアプリにもこれほしい！！ってなったんだけど、`Android`のファイルの仕様のせいで厳しそう。。。  

というのも、写真や動画や音声の素材は`フォトピッカー`や`Storage Access Framework`で選ばせているわけですが、選んだファイルへアクセスできるのって**アプリが生きている間**（プロセスが生きている間）なんですよね。  
例えばアプリを再起動したらそのファイルへはアクセスできなくなる。`Amazon S3`の署名付きURLが近いのかも。  

それじゃ使い勝手が最悪なので、`Android`は永続化出来る手段を用意してくれている。この永続化にも文章化されてない罠があるんですが、それは別の時に。  
で、この永続化を使うためには`フォトピッカー`や、`Storage Access Framework`でファイルを選ぶ必要がある。  

それ以外の方法、例えば今回のような、ドラッグアンドドロップで受け取ったファイルは永続化する事ができない気がする。多分出来なさそう。  
そのため、**ファイルをまるまる自分のストレージにコピー**する必要があるんだけど、それだと容量を無駄に消費してしまうので、なんとかならないものなのか、、、

## Storage Access Framework で素材を選びたい
これは特に懸念点もないはずで対応したい。  
`フォトピッカー`、見た目は良いんだけど選びにくい。プレビューが使いにくかったり、パスを知ってる場合にはこっちのが便利。  
サムネだけじゃ分からんからファイル名も見たいときが多々ある。

## タイムラインの機能追加
タイムライン操作はかなり向上させた、磁石モード（他の素材の隣に置く、他の素材と時間を合わせる）とか、素材の複製とか。  
動画編集中に思ってコミットを積みました。。。やっぱパソコンで作れよ。

## 文字
複数行テキストの中央揃え欲しい。つけるか。  
`Canvas`の`drawText`（だっけ？）、複数行は一行ごと`drawText()`しないといけないはずで、それがめんどくてやってなかった可能性。

## 編集履歴みたいなのほしい
履歴の一覧出したい。何を編集したか。  
タイムラインはデータクラスになってて、編集するたびにデータクラスがコピーされるので、直近のタイムライン操作履歴みたいなのは作れそう？どこを編集したかはわからんか。

## 音量スライダーの選択で段階を踏みたい
![Imgur](https://imgur.com/q7M9INK.png)

段階を踏めるようにするべきだった。やります。  
微調整すぎる。狙った位置にするのがむずい。

## スマホの入力手段だけだとタイムライン操作が難しい
パソコンで使われているタイムラインの`UI`を、何も考えずにスマホへ持ってきたけど、**あれはマウスとキーボードがある前提だったわ**。タッチ操作だと入力手段が足りない。  
範囲選択して素材をまとめて移動する方法が欲しいかもって思ったんだけど、そもそもスマホだとどうすれば良いん？

あとタイムラインのロック機能が欲しいと思った。素材が動かないように。  
スクロールするはずが素材動かしてしまった！って事故が減るはず。というか、スクロールのためにタイムラインを**開けておく必要**がある。  

スマホ向けにタイムラインをスクロールするための何かが別に必要だと思った。何かって何？  
とにかく入力手段が足りなくて困ってる。っぱこれパソコンで動画作ればよくね。

あと`Jetpack Compose`には斜めにスクロールするための`Modifier`を作って欲しいです。

## 電池
前回の充電から`26%`消費しました。って普通なの？

![Imgur](https://imgur.com/MZNTUhC.png)

## クリップボード機能が欲しい
複製とは別に、コピーしてタイムラインの好きな位置に貼り付け出来る機能がほしい。作ろうかな。

## 長い動画だとタイムラインが重くて挙動が怪しい
見えない部分まで描画してるので、今回のように`27分`とかの動画だと重たくなって、挙動が怪しい。  
複製してもワンテンポ遅れて反映されたりとか。。画面内だけ描画ってなんか綺麗にできるかなあ。。。

## 素材一覧表示が欲しいと思った
`BGM`どれ使ってたっけ？ってなることがあって確認するすべが欲しいと思った。  
あばよくば音声素材だけフィルターみたいな。

## タイムラインの下の方を見るためにスクロールすると時間も消える
`Sticky Header`みたいなのがあれば、、、、、、

## Compose+Material3+BottomSheetでテキスト選択時のメニューが出ない
`BOM`の`2024.09.00`で修正されてました！！！！

## プロジェクトを持ち出す機能が欲しい
まだリリースできてませんが、つけました。`zip`でプロジェクトに必要なファイルが詰め込まれるように。  
実質バックアップみたいな使い方ですが。。。

# おわりに
フォアグラウンドサービスでエンコードをやらせているため、アプリを離れてもエンコードが続くのが唯一良いところなのかも知れません。  
https://www.macstories.net/stories/not-an-ipad-pro-review/#lack-of-background-processes-and-system-wide-utilities